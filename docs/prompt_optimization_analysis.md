# 提示词优化分析报告

## 分析日期
2025-11-07

## 目的
分析系统提示词（nof1_system_prompt_cn2.0.md）和用户提示词（user_prompt_cn.md）中的重复内容，提供优化建议以减少token消耗和提高决策效率。

---

## 一、当前提示词结构

### 1.1 系统提示词 (nof1_system_prompt_cn2.0.md)
**主要内容：**
- 角色与身份定义
- 核心指令与逻辑
- 信号生成逻辑（对称性原则）
- 交易执行协议
  - 行动空间
  - 仓位大小计算
  - 强制性风险管理
- 输出格式规范
  - JSON结构
  - 输出规则与验证
  - 信号格式化细则

**字符数：** 约 3,500 字符

### 1.2 用户提示词 (user_prompt_cn.md)
**主要内容：**
- 交易时长、时间戳、调用次数
- 数据排序说明（最旧 → 最新）
- 时间框架说明（3分钟间隔）
- 数据优化说明（数据点数量）
- 市场情绪指标（恐惧贪婪指数）
- 所有币种的当前市场状态（占位符）
- 账户信息和业绩
  - 风险管理约束
  - 回报率、可用现金、账户价值
  - 持仓信息
  - 夏普比率

**字符数：** 约 800 字符（不含动态数据）

---

## 二、重复内容识别

### 2.1 明确重复的内容

#### ❌ 重复1：数据排序说明
- **系统提示词（第21行）：**
  ```
  **数据排序**: 所有时间序列数据（K线、指标）都按 **最旧 → 最新** 的顺序提供。数组中的**最后一个**元素是**最新**的数据。
  ```

- **用户提示词（第3行）：**
  ```
  **以下所有价格或信号数据的排序方式为:最旧 → 最新**
  ```

**优化建议：** 仅在系统提示词中保留详细说明，用户提示词中删除此行。

---

#### ❌ 重复2：风险管理约束
- **系统提示词（第50-54行）：**
  ```
  * **杠杆/信心度**:
      * `Confidence 0.3-0.5`: 杠杆 5-10x
      * `Confidence 0.5-0.7`: 杠杆 10-20x
      * `Confidence 0.7-1.0`: 杠杆 20-40x
  * **约束**: 避免单仓位 > 40% 资金。确保清算价格距入场价 > 15%。
  ```

- **用户提示词（第19-21行）：**
  ```
  **风险管理约束:**
  - 最大单笔仓位规模: 账户价值的 {{MAX_POSITION_SIZE_PCT}}%
  - 最大持仓数量: {{MAX_OPEN_POSITIONS}}
  ```

**分析：** 这两处内容有部分重叠但不完全相同：
- 系统提示词：定义杠杆与信心度的映射关系，以及清算价格约束
- 用户提示词：提供当前配置的具体数值

**优化建议：** 
- 系统提示词：保留杠杆映射和清算价格约束（这是决策规则）
- 用户提示词：保留具体数值（这是实时配置）
- **不建议删除**，因为它们服务于不同目的

---

### 2.2 隐含重复的内容

#### ⚠️ 隐含重复1：时间框架说明
- **用户提示词（第5行）：**
  ```
  **时间框架说明:** 除非在章节标题中另有说明,日内序列以 **3 分钟间隔**提供。
  ```

- **用户提示词（币种数据部分，第156行）：**
  ```
  **日内序列(3 分钟间隔,最旧 → 最新):**
  ```

**分析：** 在总体说明中已经提到"3分钟间隔"，在每个币种数据中又重复说明。

**优化建议：** 保留总体说明，在币种数据部分可简化为：
```
**日内序列(最旧 → 最新):**
```

---

#### ⚠️ 隐含重复2：数据点数量说明
- **用户提示词（第7行）：**
  ```
  **数据优化说明:** 为优化决策速度,每个指标序列统一提供最新的{{DATA_POINTS}}个数据点
  ```

**分析：** 这个说明在实际数据中已经体现（数组长度），可能不需要额外说明。

**优化建议：** 
- **保留**：这个说明帮助AI理解为什么只有10个数据点，而不是完整历史
- 但可以简化为："每个指标序列提供最新的{{DATA_POINTS}}个数据点"

---

## 三、优化建议总结

### 3.1 高优先级优化（建议立即执行）

#### 优化1：删除用户提示词中的数据排序说明
**位置：** user_prompt_cn.md 第3行

**当前：**
```markdown
**以下所有价格或信号数据的排序方式为:最旧 → 最新**
```

**优化后：** 删除此行

**理由：** 系统提示词中已有详细说明，用户提示词中无需重复

**预计节省：** ~30 tokens

---

#### 优化2：简化币种数据部分的时间框架标注
**位置：** prompt_manager.py 第156行

**当前：**
```python
**日内序列(3 分钟间隔,最旧 → 最新):**
```

**优化后：**
```python
**日内序列:**
```

**理由：** 
- "3分钟间隔"已在用户提示词开头说明
- "最旧 → 最新"已在系统提示词说明

**预计节省：** ~15 tokens × 6个币种 = ~90 tokens

---

### 3.2 中优先级优化（可选）

#### 优化3：简化数据优化说明
**位置：** user_prompt_cn.md 第7行

**当前：**
```markdown
**数据优化说明:** 为优化决策速度,每个指标序列统一提供最新的{{DATA_POINTS}}个数据点,足以捕捉关键趋势和动量变化。
```

**优化后：**
```markdown
**数据说明:** 每个指标序列提供最新的{{DATA_POINTS}}个数据点。
```

**理由：** 简化表述，减少不必要的解释

**预计节省：** ~20 tokens

---

#### 优化4：合并长期背景数据格式
**位置：** prompt_manager.py 第168-178行

**当前：** 每个指标单独一行
```
20 周期 EMA:{market_features.get('long_term_ema20', 0)} vs. 50 周期 EMA:{market_features.get('long_term_ema50', 0)}

3 周期 ATR:{market_features.get('long_term_atr3', 0)} vs. 14 周期 ATR:{market_features.get('long_term_atr14', 0)}

当前成交量:{market_features.get('long_term_current_volume', 0)} vs. 平均成交量:{market_features.get('long_term_average_volume', 0)}
```

**优化后：** 使用更紧凑的格式
```
EMA: 20={value} / 50={value} | ATR: 3={value} / 14={value} | Volume: 当前={value} / 平均={value}
```

**理由：** 减少换行和冗余文字

**预计节省：** ~30 tokens × 6个币种 = ~180 tokens

---

### 3.3 低优先级优化（需谨慎评估）

#### 优化5：简化持仓信息格式
**位置：** prompt_manager.py 第406-458行

**当前：** 使用Python字典格式显示持仓

**优化后：** 使用更紧凑的表格格式或JSON格式

**理由：** 字典格式包含大量重复的键名

**预计节省：** ~50-100 tokens（取决于持仓数量）

**风险：** 可能影响AI对持仓信息的理解

---

## 四、总体优化效果预估

### 4.1 Token节省估算

| 优化项 | 优先级 | 预计节省 (tokens) | 风险等级 |
|--------|--------|-------------------|----------|
| 删除数据排序重复说明 | 高 | 30 | 低 |
| 简化时间框架标注 | 高 | 90 | 低 |
| 简化数据优化说明 | 中 | 20 | 低 |
| 合并长期背景格式 | 中 | 180 | 中 |
| 简化持仓信息格式 | 低 | 50-100 | 高 |
| **总计** | - | **370-470** | - |

### 4.2 当前Token使用情况（参考）
根据日志显示：
```
2025-11-07 20:12:00,170 - src.ai_decision - INFO - 📊 Token 使用: prompt=5637, completion=1305, total=6942
```

**优化后预期：**
- Prompt tokens: 5637 - 400 ≈ **5237** (-7%)
- 每次调用节省约 **400 tokens**
- 按每天调用 160次 计算：每天节省 **64,000 tokens**

---

## 五、实施建议

### 5.1 分阶段实施

#### 第一阶段（立即执行）
1. 删除用户提示词中的数据排序说明
2. 简化币种数据部分的时间框架标注

**预期效果：** 节省 ~120 tokens，风险极低

#### 第二阶段（观察效果后执行）
3. 简化数据优化说明
4. 合并长期背景数据格式

**预期效果：** 额外节省 ~200 tokens，需要测试AI理解是否受影响

#### 第三阶段（谨慎评估）
5. 简化持仓信息格式

**预期效果：** 额外节省 ~100 tokens，需要充分测试

### 5.2 测试验证

每次优化后，应进行以下测试：
1. 运行至少 10 个决策周期
2. 检查AI决策的JSON格式是否正确
3. 验证AI是否正确理解市场数据
4. 确认风险管理参数是否被正确应用

---

## 六、不建议优化的内容

### 6.1 保留的"重复"内容

以下内容虽然看似重复，但服务于不同目的，**不建议删除**：

#### 1. 风险管理约束
- **系统提示词：** 定义决策规则（杠杆映射、清算价格约束）
- **用户提示词：** 提供实时配置值（最大仓位、最大持仓数）
- **理由：** 一个是"规则"，一个是"参数"

#### 2. 恐惧贪婪指数
- **系统提示词：** 解释如何使用恐惧贪婪指数（逆向信号）
- **用户提示词：** 提供当前实际数值
- **理由：** 一个是"解释"，一个是"数据"

#### 3. 输出格式说明
- **系统提示词：** 详细的JSON结构和验证规则
- **理由：** 这是核心约束，必须保留完整

---

## 七、额外建议

### 7.1 考虑使用函数调用（Function Calling）
如果Deepseek API支持函数调用，可以：
- 将JSON输出格式定义为函数schema
- 减少系统提示词中的格式说明
- 提高输出的结构化程度

**预计节省：** ~200-300 tokens

### 7.2 动态调整数据点数量
根据市场波动性动态调整：
- 高波动：提供更多数据点（15个）
- 低波动：提供更少数据点（8个）

**预计节省：** ~50-100 tokens（低波动时）

### 7.3 缓存系统提示词
如果API支持提示词缓存：
- 系统提示词可以被缓存
- 只需为用户提示词付费

**预计节省：** ~50% prompt tokens

---

## 八、结论

### 8.1 推荐执行的优化
1. ✅ 删除用户提示词中的数据排序重复说明
2. ✅ 简化币种数据部分的时间框架标注
3. ⚠️ 简化数据优化说明（可选）
4. ⚠️ 合并长期背景数据格式（需测试）

### 8.2 不推荐的优化
1. ❌ 删除风险管理约束的重复部分
2. ❌ 删除恐惧贪婪指数的解释
3. ❌ 简化输出格式说明

### 8.3 预期效果
- **Token节省：** 120-320 tokens/次调用（2-6%）
- **风险等级：** 低-中
- **实施难度：** 低

---

## 九、实施清单

### 修改文件列表
1. `prompt-template/user_prompt_cn.md` - 删除第3行数据排序说明
2. `src/prompt_manager.py` - 简化第156行和第168-178行的格式

### 测试清单
- [ ] 运行10个决策周期
- [ ] 验证JSON输出格式
- [ ] 检查AI对市场数据的理解
- [ ] 确认风险管理参数应用正确
- [ ] 对比优化前后的token使用量

---

**报告生成时间：** 2025-11-07
**建议有效期：** 长期有效，建议每季度重新评估

